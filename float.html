<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7 ]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title></title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile viewport optimized: j.mp/bplateviewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Place favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <!-- External Fonts -->
  <link href='http://fonts.googleapis.com/css?family=Ubuntu:light,lightitalic,regular,italic,500,500italic,bold,bolditalic&subset=cyrillic,latin' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Cuprum&subset=cyrillic,latin' rel='stylesheet' type='text/css'>

  <!-- CSS: implied media="all" -->
  <link rel="stylesheet" href="css/style.css?v=2">

  <!-- Uncomment if you are specifically targeting less enabled mobile browsers
  <link rel="stylesheet" media="handheld" href="css/handheld.css?v=2">  -->

  <!-- All JavaScript at the bottom, except for Modernizr which enables HTML5 elements & feature detects -->
  <script src="js/libs/modernizr-1.7.min.js"></script>
  <style type="text/css">
      body {
/*          background-color: #000000;*/
      }
      
      #main-container {
          width: 60%;
          margin: 0 auto;
      }
      article {
          height: 6em;
      }
      
      .discussion {
          background : #222222 url(img/bg.png);
      }

      .key {
          background : #666666 url(img/bg2.png);
      }

      .post {
          background : #eeeeee url(img/bg.png);
          opacity: .6;
      }

      article.active {
          outline: none;
          box-shadow: inset 0px 0px 3em 1.5em #991111, inset 0px 0px .4em .4em #ffffff, inset 0px 0px .5em .5em #000000;
      }

      article.float {
/*          outline: 6px double #ffff66;*/
          position: fixed;
          z-index: 1000;
          background-color: red;
          opacity: 1;
          box-shadow: inset 0px 0px 3em 1.5em #996611, inset 0px 0px .4em .4em #ffffff, inset 0px 0px .5em .5em #000000;
          top: 0;
          width: inherit;
      }
      
      aa {
          display: block;
          background-color: #ffffff;
          box-shadow: inset 0px 0px .2em .2em #000000;
      }

  </style>
</head>

<body>

  <div id="main-container">          

      <article  data-id="pined" data-parent="">pined</article>
      <article  data-id="1" data-parent="pined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="2" data-parent="pined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="3" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="4" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="5" data-parent="4" class="post">4<img src="img/ico_pin2.png" />1</article>
      <article  data-id="6" data-parent="4" class="post">4<img src="img/ico_pin2.png" /></article>
      <article  data-id="7" data-parent="4" class="post">4<img src="img/ico_pin2.png" /></article>
      <article  data-id="8" data-parent="7" class="post">47<img src="img/ico_pin2.png" /></article>
      <article  data-id="9" data-parent="7" class="post">47<img src="img/ico_pin2.png" /></article>
      <article  data-id="11" data-parent="9" class="post">9<img src="img/ico_pin2.png" /></article>
      <article  data-id="12" data-parent="9" class="post">9<img src="img/ico_pin2.png" /></article>
      <article  data-id="10" data-parent="7" class="post">7<img src="img/ico_pin2.png" /></article>
      <article  data-id="13" data-parent="4" class="post"><img src="img/ico_pin2.png" />1-n</article>
      <article  data-id="14" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="15" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="16" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="17" data-parent="16" class="post"><img src="img/ico_pin2.png" /></article>
      <article  data-id="18" data-parent="16" class="post"><img src="img/ico_pin2.png" /></article>
      <article  data-id="19" data-parent="16" class="post"><img src="img/ico_pin2.png" /></article>
      <article  data-id="20" data-parent="16" class="post"><img src="img/ico_pin2.png" /></article>
      <article  data-id="21" data-parent="16" class="post"><img src="img/ico_pin2.png" /></article>
      <article  data-id="22" data-parent="16" class="post"><img src="img/ico_pin2.png" /></article>
      <article  data-id="23" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="24" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="25" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="26" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="27" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="28" data-parent="27" class="post"><img src="img/ico_pin2.png" /></article>
      <article  data-id="29" data-parent="27" class="post"><img src="img/ico_pin2.png" /></article>
      <article  data-id="30" data-parent="27" class="post"><img src="img/ico_pin2.png" /></article>
      <article  data-id="31" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="32" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="33" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="34" data-parent="2" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="35" data-parent="pined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="36" data-parent="pined" class="discussion"><img src="img/ico_pinned.png" /></article>
      
      <article  data-id="unpined" data-parent="">un-pined</article>
      
      <article  data-id="38" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="39" data-parent="unpined" class="discussion">39<img src="img/ico_pinned.png" /></article>

      <article  data-id="48" data-parent="39" class="key">48<img src="img/ico_pin2_u.png" /></article>
      <article  data-id="45" data-parent="48" class="post">48-45<img src="img/ico_pin2.png" /></article>
      <article  data-id="46" data-parent="48" class="post">48-46<img src="img/ico_pin2.png" /></article>
      <article  data-id="47" data-parent="48" class="post">48-47<img src="img/ico_pin2.png" />1-n</article>
      <article  data-id="49" data-parent="39" class="key">49<img src="img/ico_pin2_u.png" /></article>
      <article  data-id="50" data-parent="39" class="key">50<img src="img/ico_pin2_u.png" /></article>
      <article  data-id="51" data-parent="50" class="post">50-51<img src="img/ico_pin2.png" /></article>
      <article  data-id="52" data-parent="50" class="post">50-52<img src="img/ico_pin2.png" /></article>
      <article  data-id="53" data-parent="50" class="post">50-53<img src="img/ico_pin2.png" /></article>
      <article  data-id="54" data-parent="50" class="post">50-54<img src="img/ico_pin2.png" /></article>
      <article  data-id="55" data-parent="50" class="post">50-55<img src="img/ico_pin2.png" /></article>
      <article  data-id="56" data-parent="50" class="post">50-56<img src="img/ico_pin2.png" /></article>
      <article  data-id="57" data-parent="39" class="key"><img src="img/ico_pin2_u.png" /></article>
      <article  data-id="58" data-parent="39" class="key"><img src="img/ico_pin2_u.png" /></article>
      
      <article  data-id="37" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="40" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="41" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="42" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="43" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="44" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      
      <article  data-id="60" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="61" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="62" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="63" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      <article  data-id="64" data-parent="unpined" class="discussion"><img src="img/ico_pinned.png" /></article>
      
  </div> <!--! end of #container -->


  <!-- JavaScript at the bottom for fast page loading -->

  <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
  <script>window.jQuery || document.write("<script src='js/libs/jquery-1.5.1.min.js'>\x3C/script>")</script>


  <!-- scripts concatenated and minified via ant build script-->
  
  <script type="text/javascript">
    (function($) {
        
        function getParents (a, parents)
        {
            parents.push(a.attr("data-id"));
            
            if (a.attr("data-parent") && a.attr("data-parent") != "")
            {
                getParents ($("article[data-id='" + a.attr("data-parent") + "']"), parents);
            }
            
            return parents;
        }
        
        function alignArticles ( )
        {
            var a = $("article.active");
            
            if (a.length > 0)
            {
                var parents = a.attr("cparents").split(",");
                parents = [ a.attr("data-id") ];
                
                var offset = 0;
                for (var i=0, l=parents.length; i<l; i++ )
                {
                    offset += alignArticle ($("article[data-id='" + parents[i] + "']"), offset);
                }
            }
            else
            {
                $("aa").css({"margin-bottom": 0 + "px"});
                $("article").removeClass("float");
            }
        }
        
        function alignArticle ( el, offset )
        {
            var
                aa = el.prev("aa"),
                st = $(document.body).scrollTop() ,
                delta = aa.offset().top - st,
                oH = el.outerHeight(true);
                
            if (delta <= 0)
            {
                aa.css({"margin-bottom": oH + "px"});
                el.css({"top" : offset + "px"}).addClass("float");
            }
            else
            {
                aa.css({"margin-bottom": 0 + "px"});
                el.css({"top" : "0px"}).removeClass("float");
                return 0;
            }
            
            var next = $("article[data-parent='" + el.attr("data-id") + "']").not(el).last();
            
            var subHeight = false;
            
            if (next.length < 1)
            {
                subHeight = true;
                next = el;
            }

            next = next.next("aa"); 

            var nextBorder = next.offset().top - st ; // ? 

            if (nextBorder <= oH)
            {
                el.css({"top": ( nextBorder + offset - (subHeight?oH:0)) + "px"});
            }
            else
            {
                el.css({"top": ( offset ) + "px"});
            }
            
            return offset;
        }
        
        $(function() {  
            $("article").click(function(){
                
                var topStart = $(this).offset().top;
                $("article").not(this).removeClass("active").removeClass("float");
                $("aa").css({"margin-bottom": 0 + "px"});
                
                var parents = getParents ($(this), []).reverse();
                $(this).attr("cparents" , parents);
                
                parents = [ $(this).attr("data-id") ]; // только для одного текущего элемента

                $(this).addClass("active");
                
                var offset = 0;
                for (var i=0, l = parents.length ; i<l; i++ )
                {
                    offset = alignArticle ($("article[data-id='" + parents[i] + "']"), offset);
                }
                
                $(document.body).stop().animate({
                    scrollTop: topStart // @todo + офсет куда двигать 
                }, 400, function(){
                    // after scroll
                });   
                
            });
            
        });
        
        $(window).bind("load", function() {
            var cnt = 0;
            $.each($("article"), function (i,el){
                $(el).html( $(el).html() 
                    + " <div style='color:#ffffff; font-weight: bold;'> "
                    + "id:" + $(el).attr("data-id")
                    + " <br /> "
                    + "parent:" + $(el).attr("data-parent")
                    + "</div>"
                ).css({"z-index": 1000 - cnt});
                
                cnt ++;
                    
                $("<aa>")
//                    .attr("data-id", $(el).attr("data-id"))
//                    .css({"display": "none", "height": $(el).outerHeight(true)})
                    .insertBefore($(el));
            });
        });
        
        $(window).bind("scroll", function( e ) {
//            alignArticle();
            alignArticles();
        });      

        
    })(jQuery);
      
  </script>
  <!-- end scripts-->


</body>
</html> 